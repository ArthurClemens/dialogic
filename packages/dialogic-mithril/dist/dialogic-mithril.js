!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("mithril")):"function"==typeof define&&define.amd?define(["exports","mithril"],n):n((t=t||self).polythene={},t.m)}(this,function(t,n){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n;const e="show",i="hide",o={className:!0,component:!0,didHide:!0,didShow:!0,hideDelay:!0,hideDuration:!0,hideTimingFunction:!0,showClassName:!0,showDelay:!0,showDuration:!0,showTimingFunction:!0,timeout:!0,transitionClassName:!0,transitions:!0},s=(t,n)=>{const i=t.domElements?t.domElements.domElement:null;if(!i)throw new Error("No DOM element");return new Promise(o=>{const s=i.style,u=window.getComputedStyle(i),d=n===e,c=r({showDuration:t.showDuration,showDelay:t.showDelay,showTimingFunction:t.showTimingFunction,hideDuration:t.hideDuration,hideDelay:t.hideDelay,hideTimingFunction:t.hideTimingFunction,transitions:t.transitions,domElements:t.domElements},d),m=void 0!==c.duration?1e3*c.duration:u?a(u.transitionDuration):0,l=void 0!==c.delay?1e3*c.delay:u?a(u.transitionDelay):0,p=m+l;c.before&&"function"==typeof c.before&&(s.transitionDuration="0ms",s.transitionDelay="0ms",c.before()),(()=>{const n=c.timingFunction||(u?u.transitionTimingFunction:void 0);n&&(s.transitionTimingFunction=n),s.transitionDuration=m+"ms",s.transitionDelay=l+"ms",t.transitionClassName&&i.classList.add(t.transitionClassName),t.showClassName&&(t.showClassElement||i).classList[d?"add":"remove"](t.showClassName);c.transition&&c.transition()})(),setTimeout(()=>{c.after&&"function"==typeof c.after&&c.after(),t.transitionClassName&&i.classList.remove(t.transitionClassName),o()},p)})},a=t=>{const n=parseFloat(t)*(-1===t.indexOf("ms")?1e3:1);return isNaN(n)?0:n},r=(t,n)=>{const[e,i,o,s]=n?[t.showDuration,t.showDelay,t.showTimingFunction,t.transitions?t.transitions.show:void 0]:[t.hideDuration,t.hideDelay,t.hideTimingFunction,t.transitions?t.transitions.hide:void 0];return{duration:e,delay:i,timingFunction:o,...s?s(t.domElements):void 0}};var u=function(t,n){return t(n={exports:{}},n.exports),n.exports}(function(t){!function(){e.SKIP={},e.lift=function(){var t=arguments[0];return o(Array.prototype.slice.call(arguments,1)).map(function(n){return t.apply(void 0,n)})},e.scan=function(t,n,i){var o=i.map(function(i){var o=t(n,i);return o!==e.SKIP&&(n=o),o});return o(n),o},e.merge=o,e.combine=i,e.scanMerge=function(t,n){var e=t.map(function(t){return t[0]}),o=i(function(){var i=arguments[arguments.length-1];return e.forEach(function(e,o){i.indexOf(e)>-1&&(n=t[o][1](n,e()))}),n},e);return o(n),o},e["fantasy-land/of"]=e;var n=!1;function e(t){var n,o=[],a=[];function r(n){return arguments.length&&n!==e.SKIP&&(t=n,s(r)&&(r._changing(),r._state="active",o.forEach(function(n,e){n(a[e](t))}))),t}return r.constructor=e,r._state=arguments.length&&t!==e.SKIP?"active":"pending",r._parents=[],r._changing=function(){s(r)&&(r._state="changing"),o.forEach(function(t){t._changing()})},r._map=function(n,i){var s=i?e():e(n(t));return s._parents.push(r),o.push(s),a.push(n),s},r.map=function(t){return r._map(t,"active"!==r._state)},r.toJSON=function(){return null!=t&&"function"==typeof t.toJSON?t.toJSON():t},r["fantasy-land/map"]=r.map,r["fantasy-land/ap"]=function(t){return i(function(t,n){return t()(n())},[t,r])},r._unregisterChild=function(t){var n=o.indexOf(t);-1!==n&&(o.splice(n,1),a.splice(n,1))},Object.defineProperty(r,"end",{get:function(){return n||((n=e()).map(function(t){return!0===t&&(r._parents.forEach(function(t){t._unregisterChild(r)}),r._state="ended",r._parents.length=o.length=a.length=0),t}),n)}}),r}function i(t,n){var i=n.every(function(t){if(t.constructor!==e)throw new Error("Ensure that each item passed to stream.combine/stream.merge/lift is a stream");return"active"===t._state}),o=i?e(t.apply(null,n.concat([n]))):e(),s=[],a=n.map(function(e){return e._map(function(a){return s.push(e),(i||n.every(function(t){return"pending"!==t._state}))&&(i=!0,o(t.apply(null,n.concat([s]))),s=[]),a},!0)}),r=o.end.map(function(t){!0===t&&(a.forEach(function(t){t.end(!0)}),r.end(!0))});return o}function o(t){return i(function(){return t.map(function(t){return t()})},t)}function s(t){return"pending"===t._state||"active"===t._state||"changing"===t._state}Object.defineProperty(e,"HALT",{get:function(){return n||console.log("HALT is deprecated and has been renamed to SKIP"),n=!0,e.SKIP}}),t.exports=e}()});const d=(t,n)=>{const e=((t,n)=>n.find(n=>n.id===t))(t,n);return n.indexOf(e)},c=(t,n)=>[n,t.id,t.spawn].filter(Boolean).join("-"),m={initialState:{store:{}},actions:t=>({add:(n,e)=>{t(i=>{const o=i.store[n]||[];return i.store[n]=[...o,e],e.timer&&e.timer.states.map(()=>m.actions(t).refresh()),i})},remove:(n,e)=>{t(t=>{const i=t.store[n]||[],o=((t,n)=>{const e=d(t,n);return-1!==e&&n.splice(e,1),n})(e,i);return t.store[n]=o,t})},replace:(n,e,i)=>{t(t=>{const o=t.store[n]||[];if(o){const s=d(e,o);-1!==s&&(o[s]=i,t.store[n]=[...o])}return t})},removeAll:n=>{t(t=>(t.store[n]=[],t))},store:(n,e)=>{t(t=>(t.store[n]=[...e],t))},refresh:()=>{t(t=>({...t}))}}),selectors:t=>{const n={getStore:()=>{return t().store},find:(n,e)=>{const i=t().store[n]||[],o=c(e,n),s=i.find(t=>t.id===o);return s?{just:s}:{nothing:void 0}},getAll:(n,e)=>{const i=t().store[n]||[],o=void 0!==e?e.spawn:void 0;return void 0!==o?i.filter(t=>t.spawnOptions.spawn===o):i},getCount:(t,e)=>n.getAll(t,e).length};return n}},l=u(),p=u.scan((t,n)=>n(t),{...m.initialState},l),f={...m.actions(l)},w={...m.selectors(p)},h={timerId:void 0,isPaused:void 0,remaining:void 0,startTime:void 0,callback:()=>{},timeoutFn:()=>{},promise:void 0,onDone:()=>{},onAbort:()=>{}},g=(t,n,e,i)=>{const o=()=>{n(),t.onDone(),i()};return{timeoutFn:o,promise:new Promise((n,e)=>{t.onDone=()=>n(),t.onAbort=()=>e()}),...t.isPaused?{}:{startTime:(new Date).getTime(),timerId:window.setTimeout(o,e),remaining:e}}},O=t=>(window.clearTimeout(t.timerId),{timerId:h.timerId}),v=t=>({...O(t)}),y=t=>({...O(t),isPaused:!0,remaining:P(t)}),S=(t,n)=>{window.clearTimeout(t.timerId);const e=n?Math.max(t.remaining||0,n):t.remaining;return{startTime:(new Date).getTime(),isPaused:!1,remaining:e,timerId:window.setTimeout(t.timeoutFn,e)}},P=t=>void 0===t.remaining?void 0:t.remaining-((new Date).getTime()-(t.startTime||0)),_=()=>{const t={initialState:h,actions:n=>({start:(e,i)=>{n(o=>({...o,...O(o),...g(o,e,i,()=>t.actions(n).done()),...o.isPaused&&y(o)}))},stop:()=>{n(t=>({...t,...v(t),...h}))},pause:()=>{n(t=>({...t,...y(t)}))},resume:t=>{n(n=>({...n,...n.isPaused&&S(n,t)}))},abort:()=>{n(t=>(t.onAbort(),{...t,...O(t)}))},done:()=>{n(t=>h)},refresh:()=>{n(t=>({...t}))}}),selectors:t=>({isPaused:()=>{return t().isPaused},getRemaining:()=>{const n=t();return n.isPaused?n.remaining:P(n)},getResultPromise:()=>{return t().promise}})},n=u(),e=u.scan((t,n)=>n(t),{...t.initialState},n);return{states:e,actions:{...t.actions(n)},selectors:{...t.selectors(e)}}};let D=0;const T=()=>D===Number.MAX_SAFE_INTEGER?0:D++,N="none",b="hiding",E=t=>{return Object.keys(t).reduce((n,e)=>{const i=t[e];return o[e]?n.transitionOptions[e]=i:n.instanceOptions[e]=i,n},{transitionOptions:{},instanceOptions:{}})},j=t=>n=>e=>(i,o)=>new Promise(s=>{const a={...n,...o},r=c(a,t),{transitionOptions:u,instanceOptions:d}=E(i),m={...e,...u};m.didShow=t=>(i.didShow&&i.didShow(t),s(t)),m.didHide=t=>(i.didHide&&i.didHide(t),s(t));const l=T().toString(),p={spawnOptions:a,transitionOptions:m,instanceTransitionOptions:u,instanceOptions:d,id:r,timer:m.timeout?_():void 0,key:l,transitionState:N},h=w.find(t,a);if(h.just&&!a.queued){const n=h.just,e=n.instanceTransitionOptions,i={...p,instanceTransitionOptions:e};f.replace(t,n.id,i),m.didShow(a.id)}else f.add(t,p)}),I=t=>n=>e=>{const i={...n,...e};return w.find(t,i)},C=t=>n=>e=>(i,o)=>{const s=I(n)(e)(i);return s.just?t(n,s.just,o):Promise.resolve()},A=C((t,n)=>n.transitionState!==b?(n.transitionState=b,z(t,n)):Promise.resolve()),F=C((t,n)=>(n&&n.timer&&n.timer.actions.pause(),Promise.resolve())),x=C((t,n,e={})=>(n&&n.timer&&n.timer.actions.resume(e.minimumDuration),Promise.resolve())),H=t=>n=>e=>i=>{const o=I(n)(e)(i);return o.just&&o.just&&o.just.timer?o.just.timer.selectors[t]():void 0},q=H("isPaused"),M=H("getRemaining"),R=t=>()=>(w.getAll(t).forEach(t=>t.timer&&t.timer.actions.abort()),f.removeAll(t),Promise.resolve()),k=(t,n)=>{const{transitionOptions:e}=E(n);return{...t,transitionOptions:{...t.transitionOptions,...e}}},K=t=>n=>(e,i)=>{const o={...n,...i},s=w.getAll(t),a=s.filter(t=>!o.queued&&!t.spawnOptions.queued),r=s.filter(t=>o.queued||t.spawnOptions.queued);if(a.forEach(n=>z(t,k(n,e))),r.length>0){const[n]=r;f.store(t,[n]),z(t,k(n,e)).then(()=>f.removeAll(t))}},L=t=>n=>w.getCount(t,n),J=(t,n)=>{try{return s({...t.instanceTransitionOptions,...t.transitionOptions},n)}catch(t){throw new Error(`Transition error: ${t}`)}},$=async function(t,n){return await J(n,e),n.transitionOptions.didShow&&await n.transitionOptions.didShow(n.spawnOptions.id),n.transitionOptions.timeout&&n.timer&&await async function(t,n,e,i){return e.actions.start(()=>z(t,n),i),H("getResultPromise")}(t,n,n.timer,n.transitionOptions.timeout),n.spawnOptions.id},z=async function(t,n){return n.timer&&n.timer.actions.stop(),await J(n,i),n.transitionOptions.didHide&&await n.transitionOptions.didHide(n.spawnOptions.id),f.remove(t,n.id),n.spawnOptions.id},B="notification",G=`default_${B}`,X=`default_${B}`,Q={id:G,queued:!0,spawn:X},U=j(B)(Q)({timeout:3e3}),V=A(B)(Q),W=F(B)(Q),Y=x(B)(Q),Z=q(B)(Q),tt=I(B)(Q),nt=M(B)(Q),et=K(B)(Q),it=R(B),ot=L(B);var st=Object.freeze({ns:B,defaultId:G,defaultSpawn:X,defaultSpawnOptions:Q,show:U,hide:V,pause:W,resume:Y,isPaused:Z,getMaybeItem:tt,getRemaining:nt,hideAll:et,resetAll:it,getCount:ot});const at="dialog",rt={id:"default_dialog",spawn:"default_dialog"},ut=j(at)(rt)({}),dt=A(at)(rt),ct=F(at)(rt),mt=x(at)(rt),lt=q(at)(rt),pt=I(at)(rt),ft=M(at)(rt),wt=K(at)(rt),ht=R(at),gt=L(at);var Ot=Object.freeze({ns:at,defaultId:"default_dialog",defaultSpawn:"default_dialog",defaultSpawnOptions:rt,show:ut,hide:dt,pause:ct,resume:mt,isPaused:lt,getMaybeItem:pt,getRemaining:ft,hideAll:wt,resetAll:ht,getCount:gt});const vt=t=>(n,e)=>{const i=w.find(t,n.detail.spawnOptions);i.just&&(i.just.instanceTransitionOptions=n.detail.transitionOptions);const o=w.find(t,n.detail.spawnOptions);o.just&&e(t,o.just)},yt=({attrs:t})=>{let e;const i=[t.transitionOptions.className,t.instanceOptions.className].join(" "),o=n=>{n({detail:{spawnOptions:t.spawnOptions,transitionOptions:{className:t.transitionOptions.className,showClassName:t.transitionOptions.showClassName,domElements:{domElement:e}}}})},s=()=>{o(t.onShow)},a=()=>{o(t.onHide)};return{oncreate:n=>{e=n.dom,o(t.onMount)},view:()=>n("div",{className:i},n(t.transitionOptions.component,{...t.instanceOptions,show:s,hide:a},[n("div","Instance"),n("button",{onclick:()=>a()},"Hide from instance")]))}},St={view:({attrs:t})=>{const e=(t=>n=>vt(t)(n,$))(t.ns),i=(t=>n=>vt(t)(n,$))(t.ns),o=(t=>n=>vt(t)(n,z))(t.ns),s=(t.spawnOptions||{}).spawn||"";return((t,n,e)=>{return((t,n)=>t.filter(t=>t.spawnOptions.spawn===n))(((t,n)=>{let e=0;return t.map(t=>({item:t,queueCount:t.spawnOptions.queued?e++:0})).filter(({queueCount:t})=>0===t).map(({item:t})=>t)})(n[t]||[]),e)})(t.ns,w.getStore(),s).map(t=>n(yt,{key:t.key,spawnOptions:t.spawnOptions,transitionOptions:t.transitionOptions,instanceOptions:t.instanceOptions,onMount:e,onShow:i,onHide:o}))}},Pt={view:({attrs:t})=>{const e={id:t.id||Ot.defaultId,spawn:t.spawn||Ot.defaultSpawn};return n(St,{spawnOptions:e,ns:Ot.ns})}};p.map(t=>n.redraw()),t.Dialog=Pt,t.Notification=({attrs:t})=>{const e={id:t.id||st.defaultId,spawn:t.spawn||st.defaultSpawn};return{view:()=>n(St,{spawnOptions:e,ns:st.ns})}},t.dialog=Ot,t.notification=st,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=dialogic-mithril.js.map
