!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("mithril/stream")):"function"==typeof define&&define.amd?define(["exports","mithril/stream"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).dialogic={},t.Stream)}(this,(function(t,e){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=i(e);function n(t,e,i,s){return new(i||(i=Promise))((function(n,o){function a(t){try{d(s.next(t))}catch(t){o(t)}}function r(t){try{d(s.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,r)}d((s=s.apply(t,e||[])).next())}))}const o=(...t)=>e=>t.filter(Boolean).reduce((t,e)=>e(t),e),a=({domElement:t,prop:e})=>{const i=document.defaultView;if(i){const s=i.getComputedStyle(t);if(s)return s.getPropertyValue(e)}},r="show",d="hide",c=(t,e,i)=>{const s=i[e]||{};Object.keys(s).forEach(e=>{const i=s[e].toString();t.style[e]=i})},l=(t,e)=>t.split(/ /).map(t=>`${t}-${e}`),u=(t,e,i,s)=>{if(e.styles){const n=((t,e)=>("function"==typeof e?e(t):e)||{})(t,e.styles);c(t,"default",n),s&&(t=>{t.style.transitionDuration="0ms"})(t),c(t,i,n)}if(e.className){const s={showStart:l(e.className,"show-start"),showEnd:l(e.className,"show-end"),hideStart:l(e.className,"hide-start"),hideEnd:l(e.className,"hide-end")};((t,e)=>{t.classList.remove(...e.showStart,...e.showEnd,...e.hideStart,...e.hideEnd)})(t,s),s&&t.classList.add(...s[i])}t.scrollTop},m={showStart:{nextStep:"showEnd"},showEnd:{nextStep:void 0},hideStart:{nextStep:"hideEnd"},hideEnd:{nextStep:void 0}},g=(t,e)=>{const i=t.domElement;if(!i)return Promise.resolve("no domElement");clearTimeout(t.__transitionTimeoutId__);let s=e===r?"showStart":"hideStart";return new Promise(e=>{u(i,t,s,"showStart"===s),setTimeout(()=>{const n=m[s].nextStep;if(n){s=n,u(i,t,s);const o=(t=>{const e=a({domElement:t,prop:"transition-duration"}),i=void 0!==e?p(e):0,s=a({domElement:t,prop:"transition-delay"});return i+(void 0!==s?p(s):0)})(i);t.__transitionTimeoutId__=window.setTimeout(e,o)}},0)})},p=t=>{const e=parseFloat(t)*(-1===t.indexOf("ms")?1e3:1);return isNaN(e)?0:e},h=(t,e)=>{const i=((t,e)=>e.find(e=>e.id===t))(t,e);return e.indexOf(i)},f=(t,e)=>[e,t.id,t.spawn].filter(Boolean).join("-"),O={initialState:{store:{}},actions:t=>({add:(e,i)=>{t(s=>{const n=s.store[e]||[];return s.store[e]=[...n,i],i.timer&&i.timer.states.map(()=>O.actions(t).refresh()),s})},remove:(e,i)=>{t(t=>{const s=t.store[e]||[],n=((t,e)=>{const i=h(t,e);return-1!==i&&e.splice(i,1),e})(i,s);return t.store[e]=n,t})},replace:(e,i,s)=>{t(t=>{const n=t.store[e]||[];if(n){const o=h(i,n);-1!==o&&(n[o]=s,t.store[e]=[...n])}return t})},removeAll:e=>{t(t=>(t.store[e]=[],t))},store:(e,i)=>{t(t=>(t.store[e]=[...i],t))},refresh:()=>{t(t=>Object.assign({},t))}}),selectors:t=>{const e={getStore:()=>t().store,find:(e,i)=>{const s=t().store[e]||[],n=f(i,e),o=s.find(t=>t.id===n);return o?{just:o}:{nothing:void 0}},getAll:(e,i)=>{const s=t().store[e]||[],n=void 0!==i?i.spawn:void 0,o=void 0!==i?i.id:void 0,a=void 0!==n?s.filter(t=>t.identityOptions.spawn===n):s;return void 0!==o?a.filter(t=>t.identityOptions.id===o):a},getCount:(t,i)=>e.getAll(t,i).length};return e}},w=s.default(),b=s.default.scan((t,e)=>e(t),Object.assign({},O.initialState),w),j=Object.assign({},O.actions(w)),v=Object.assign({},O.selectors(b)),S={callback:()=>{},isPaused:!1,onAbort:()=>{},onDone:()=>{},promise:void 0,remaining:void 0,startTime:void 0,timeoutFn:()=>{},timerId:void 0},y=t=>(window.clearTimeout(t.timerId),{timerId:S.timerId}),P=t=>Object.assign(Object.assign({},y(t)),{isPaused:!0,remaining:T(t)}),T=t=>0===t.remaining||void 0===t.remaining?t.remaining:t.remaining-((new Date).getTime()-(t.startTime||0)),E=()=>{const t={initialState:S,actions:e=>({start:(i,s)=>{e(n=>Object.assign(Object.assign(Object.assign(Object.assign({},n),y(n)),((t,e,i,s)=>{const n=()=>{e(),t.onDone(),s()};return Object.assign({timeoutFn:n,promise:new Promise(e=>{t.onDone=()=>e(),t.onAbort=()=>e()})},t.isPaused?{}:{startTime:(new Date).getTime(),timerId:window.setTimeout(n,i),remaining:i})})(n,i,s,()=>t.actions(e).done())),n.isPaused&&P(n)))},stop:()=>{e(t=>Object.assign(Object.assign(Object.assign({},t),(t=>Object.assign({},y(t)))(t)),S))},pause:()=>{e(t=>Object.assign(Object.assign({},t),!t.isPaused&&P(t)))},resume:t=>{e(e=>Object.assign(Object.assign({},e),e.isPaused&&((t,e)=>{window.clearTimeout(t.timerId);const i=e?Math.max(t.remaining||0,e):t.remaining;return{startTime:(new Date).getTime(),isPaused:!1,remaining:i,timerId:window.setTimeout(t.timeoutFn,i)}})(e,t)))},abort:()=>{e(t=>(t.onAbort(),Object.assign(Object.assign({},t),y(t))))},done:()=>{e(t=>S)},refresh:()=>{e(t=>Object.assign({},t))}}),selectors:t=>({isPaused:()=>t().isPaused,getRemaining:()=>{const e=t();return e.isPaused?e.remaining:T(e)},getResultPromise:()=>t().promise})},e=s.default(),i=s.default.scan((t,e)=>e(t),Object.assign({},t.initialState),e);return{states:i,actions:Object.assign({},t.actions(e)),selectors:Object.assign({},t.selectors(i))}};let x=0;const A=0,_=1,k=2,q=t=>e=>void 0!==t.spawn?e.filter(e=>e.identityOptions.spawn===t.spawn):e,I=t=>{let e=0;return t.map(t=>({item:t,queueCount:t.dialogicOptions.queued?e++:0})).filter(({queueCount:t})=>0===t).map(({item:t})=>t)},D=(t,e={})=>({id:e.id||t.id,spawn:e.spawn||t.spawn}),H=(t,e={})=>{const i={id:e.dialogic?e.dialogic.id:void 0,spawn:e.dialogic?e.dialogic.spawn:void 0};return{identityOptions:D(t||{},i),dialogicOptions:Object.assign(Object.assign(Object.assign({},t),e.dialogic),{__transitionTimeoutId__:0}),passThroughOptions:(t=>{const e=Object.assign({},t);return delete e.dialogic,e})(e)}},C=t=>e=>(i={})=>{const{identityOptions:s,dialogicOptions:n,passThroughOptions:o}=H(e,i);return new Promise(a=>{const r={willShow:t=>(n.willShow&&n.willShow(t),a(t)),willHide:t=>(n.willHide&&n.willHide(t),a(t)),didShow:t=>(n.didShow&&n.didShow(t),a(t)),didHide:t=>(n.didHide&&n.didHide(t),a(t))},d={ns:t,identityOptions:s,dialogicOptions:n,callbacks:r,passThroughOptions:o,id:f(s,t),timer:n.timeout?E():void 0,key:(x===Number.MAX_VALUE?0:x++).toString(),transitionState:A},c=v.find(t,s);if(c.just&&n.toggle){const s=N(t)(e)(i);return a(s)}if(c.just&&!n.queued){const e=c.just,i=e.dialogicOptions,s=Object.assign(Object.assign({},d),{key:e.key,transitionState:e.transitionState,dialogicOptions:i});j.replace(t,e.id,s)}else j.add(t,d);a(d)})},N=t=>e=>i=>{const{identityOptions:s,dialogicOptions:n,passThroughOptions:o}=H(e,i),a=v.find(t,s);if(a.just){const e=a.just,i=Object.assign(Object.assign({},e),{dialogicOptions:Object.assign(Object.assign({},e.dialogicOptions),n),passThroughOptions:Object.assign(Object.assign({},e.passThroughOptions),{passThroughOptions:o})});return j.replace(t,e.id,i),i.transitionState!==k?K(i):Promise.resolve(i)}return Promise.resolve()},F=t=>e=>e=>{const i=$(t,e).filter(t=>!!t.timer);return i.forEach(t=>t.timer&&t.timer.actions.pause()),Promise.all(i)},R=t=>e=>e=>{const i=e||{},s={id:i.id,spawn:i.spawn},n=$(t,s).filter(t=>!!t.timer);return n.forEach(t=>t.timer&&t.timer.actions.resume(i.minimumDuration)),Promise.all(n)},M=(t,e)=>i=>s=>n=>{const o=(t=>e=>i=>v.find(t,D(e,i)))(i)(s)(n);return o.just&&o.just&&o.just.timer?o.just.timer.selectors[t]():e},L=M("isPaused",!1),V=M("getRemaining",void 0),B=t=>e=>e=>!!$(t,e).length,$=(t,e)=>{const i=v.getAll(t);let s;return s=e?o(q(e),(t=>e=>void 0!==t.id?e.filter(e=>e.identityOptions.id===t.id):e)(e))(i):i,s},U=t=>e=>e=>{const i=$(t,e),s=[];return i.forEach(t=>{t.timer&&t.timer.actions.abort(),s.push(t)}),e?s.forEach(e=>{j.remove(t,e.id)}):j.removeAll(t),Promise.resolve(s)},X=(t,e)=>Object.assign(Object.assign({},t),{dialogicOptions:Object.assign(Object.assign({},t.dialogicOptions),e)}),z=t=>e=>e=>{const i=e||{},s={id:i.id,spawn:i.spawn},n=$(t,s),o=n.filter(t=>!i.queued&&!t.dialogicOptions.queued),a=n.filter(t=>i.queued||t.dialogicOptions.queued),r=[];if(o.forEach(t=>r.push(K(X(t,i)))),a.length>0){const[e]=a;j.store(t,[e]),r.push(K(X(e,i)))}return Promise.all(r)},G=t=>e=>v.getCount(t,e),J=(t,e)=>g(t.dialogicOptions,e),K=function(t){return n(this,void 0,void 0,(function*(){t.transitionState=k,t.timer&&t.timer.actions.stop(),t.callbacks.willHide&&t.callbacks.willHide(t),yield J(t,d),t.callbacks.didHide&&t.callbacks.didHide(t);const e=Object.assign({},t);return j.remove(t.ns,t.id),Promise.resolve(e)}))},Q=({ns:t,queued:e,timeout:i})=>{const s="default_"+t,n="default_"+t,o=Object.assign(Object.assign({id:s,spawn:n},e&&{queued:e}),void 0!==i&&{timeout:i});return{ns:t,defaultId:s,defaultSpawn:n,defaultDialogicOptions:o,show:C(t)(o),hide:N(t)(o),hideAll:z(t)(o),resetAll:U(t)(o),pause:F(t)(o),resume:R(t)(o),exists:B(t)(o),getCount:G(t),isPaused:L(t)(o),getRemaining:V(t)(o)}},W=Q({ns:"dialog"}),Y=Q({ns:"notification",queued:!0,timeout:3e3});t.actions=j,t.dialog=W,t.dialogical=Q,t.exists=B,t.filterCandidates=(t,e,i)=>{const s=e[t]||[];return 0==s.length?[]:o(q(i),I)(s)},t.getCount=G,t.getRemaining=V,t.getTimerProperty=M,t.hide=N,t.hideAll=z,t.hideItem=K,t.isPaused=L,t.notification=Y,t.pause=F,t.remaining=t=>{let e,i=void 0,s=!1;const n={id:t.id,spawn:t.spawn},o=()=>{const a=t.instance.getRemaining(n);i!==a&&(i=void 0===a?a:t.roundToSeconds?Math.round(Math.max(a,0)/1e3):Math.max(a,0)),t.callback(i),t.instance.exists(n)?s||(e=window.requestAnimationFrame(o)):(window.cancelAnimationFrame(e),s=!0)};e=window.requestAnimationFrame(o)},t.resetAll=U,t.resume=R,t.selectors=v,t.setDomElement=(t,e)=>{e.dialogicOptions.domElement=t},t.show=C,t.showItem=function(t){return n(this,void 0,void 0,(function*(){return t.callbacks.willShow&&t.callbacks.willShow(t),t.transitionState!==_&&(t.transitionState=_,yield J(t,r)),t.callbacks.didShow&&t.callbacks.didShow(t),t.dialogicOptions.timeout&&t.timer&&(yield function(t,e,i){return n(this,void 0,void 0,(function*(){return e.actions.start(()=>K(t),i),M("getResultPromise",void 0)}))}(t,t.timer,t.dialogicOptions.timeout)),Promise.resolve(t)}))},t.states=b,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=dialogic.js.map
