!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("mithril/stream")):"function"==typeof define&&define.amd?define(["exports","mithril/stream"],e):e((t=t||self).dialogic={},t.Stream)}(this,(function(t,e){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;const i=(...t)=>e=>t.filter(Boolean).reduce((t,e)=>e(t),e),o=({domElement:t,prop:e})=>{const i=document.defaultView;if(i){const o=i.getComputedStyle(t);if(o)return o.getPropertyValue(e)}},n="show",s="hide",r=(t,e,i)=>{const o=i[e]||{};Object.keys(o).forEach(e=>{const i=o[e].toString();t.style[e]=i})},a=(t,e)=>t.split(/ /).map(t=>`${t}-${e}`),d=(t,e,i,o)=>{if(e.styles){const n=((t,e)=>("function"==typeof e?e(t):e)||{})(t,e.styles);r(t,"default",n),o&&(t=>{t.style.transitionDuration="0ms"})(t),r(t,i,n)}if(e.className){const o={showStart:a(e.className,"show-start"),showEnd:a(e.className,"show-end"),hideStart:a(e.className,"hide-start"),hideEnd:a(e.className,"hide-end")};((t,e)=>{t.classList.remove(...e.showStart,...e.showEnd,...e.hideStart,...e.hideEnd)})(t,o),o&&t.classList.add(...o[i])}t.scrollTop},l={showStart:{nextStep:"showEnd"},showEnd:{nextStep:void 0},hideStart:{nextStep:"hideEnd"},hideEnd:{nextStep:void 0}},u=(t,e)=>{const i=t.domElement;if(!i)return Promise.resolve("no domElement");clearTimeout(t.__transitionTimeoutId__);let s=e===n?"showStart":"hideStart";return new Promise(e=>{d(i,t,s,"showStart"===s),setTimeout(()=>{const n=l[s].nextStep;if(n){s=n,d(i,t,s);const r=(t=>{const e=o({domElement:t,prop:"transition-duration"}),i=void 0!==e?c(e):0,n=o({domElement:t,prop:"transition-delay"});return i+(void 0!==n?c(n):0)})(i);t.__transitionTimeoutId__=setTimeout(e,r)}},0)})},c=t=>{const e=parseFloat(t)*(-1===t.indexOf("ms")?1e3:1);return isNaN(e)?0:e},m=(t,e)=>{const i=((t,e)=>e.find(e=>e.id===t))(t,e);return e.indexOf(i)},p=(t,e)=>[e,t.id,t.spawn].filter(Boolean).join("-"),g={initialState:{store:{}},actions:t=>({add:(e,i)=>{t(o=>{const n=o.store[e]||[];return o.store[e]=[...n,i],i.timer&&i.timer.states.map(()=>g.actions(t).refresh()),o})},remove:(e,i)=>{t(t=>{const o=t.store[e]||[],n=((t,e)=>{const i=m(t,e);return-1!==i&&e.splice(i,1),e})(i,o);return t.store[e]=n,t})},replace:(e,i,o)=>{t(t=>{const n=t.store[e]||[];if(n){const s=m(i,n);-1!==s&&(n[s]=o,t.store[e]=[...n])}return t})},removeAll:e=>{t(t=>(t.store[e]=[],t))},store:(e,i)=>{t(t=>(t.store[e]=[...i],t))},refresh:()=>{t(t=>({...t}))}}),selectors:t=>{const e={getStore:()=>t().store,find:(e,i)=>{const o=t().store[e]||[],n=p(i,e),s=o.find(t=>t.id===n);return s?{just:s}:{nothing:void 0}},getAll:(e,i)=>{const o=t().store[e]||[],n=void 0!==i?i.spawn:void 0,s=void 0!==i?i.id:void 0,r=void 0!==n?o.filter(t=>t.identityOptions.spawn===n):o;return void 0!==s?r.filter(t=>t.identityOptions.id===s):r},getCount:(t,i)=>e.getAll(t,i).length};return e}},h=e(),f=e.scan((t,e)=>e(t),{...g.initialState},h),w={...g.actions(h)},v={...g.selectors(f)},O={callback:()=>{},isPaused:!1,onAbort:()=>{},onDone:()=>{},promise:void 0,remaining:void 0,startTime:void 0,timeoutFn:()=>{},timerId:void 0},S=(t,e,i,o)=>{const n=()=>{e(),t.onDone(),o()};return{timeoutFn:n,promise:new Promise((e,i)=>{t.onDone=()=>e(),t.onAbort=()=>e()}),...t.isPaused?{}:{startTime:(new Date).getTime(),timerId:window.setTimeout(n,i),remaining:i}}},P=t=>(window.clearTimeout(t.timerId),{timerId:O.timerId}),y=t=>({...P(t)}),T=t=>({...P(t),isPaused:!0,remaining:b(t)}),E=(t,e)=>{window.clearTimeout(t.timerId);const i=e?Math.max(t.remaining||0,e):t.remaining;return{startTime:(new Date).getTime(),isPaused:!1,remaining:i,timerId:window.setTimeout(t.timeoutFn,i)}},b=t=>0===t.remaining||void 0===t.remaining?t.remaining:t.remaining-((new Date).getTime()-(t.startTime||0)),A=()=>{const t={initialState:O,actions:e=>({start:(i,o)=>{e(n=>({...n,...P(n),...S(n,i,o,()=>t.actions(e).done()),...n.isPaused&&T(n)}))},stop:()=>{e(t=>({...t,...y(t),...O}))},pause:()=>{e(t=>({...t,...!t.isPaused&&T(t)}))},resume:t=>{e(e=>({...e,...e.isPaused&&E(e,t)}))},abort:()=>{e(t=>(t.onAbort(),{...t,...P(t)}))},done:()=>{e(t=>O)},refresh:()=>{e(t=>({...t}))}}),selectors:t=>({isPaused:()=>t().isPaused,getRemaining:()=>{const e=t();return e.isPaused?e.remaining:b(e)},getResultPromise:()=>t().promise})},i=e(),o=e.scan((t,e)=>e(t),{...t.initialState},i);return{states:o,actions:{...t.actions(i)},selectors:{...t.selectors(o)}}};let _=0;const x=0,j=1,q=2,I=t=>e=>void 0!==t.spawn?e.filter(e=>e.identityOptions.spawn===t.spawn):e,D=t=>{let e=0;return t.map(t=>({item:t,queueCount:t.dialogicOptions.queued?e++:0})).filter(({queueCount:t})=>0===t).map(({item:t})=>t)},k=(t,e={})=>({id:e.id||t.id,spawn:e.spawn||t.spawn}),C=(t,e={})=>{const i={id:e.dialogic?e.dialogic.id:void 0,spawn:e.dialogic?e.dialogic.spawn:void 0};return{identityOptions:k(t||{},i),dialogicOptions:{...t,...e.dialogic,__transitionTimeoutId__:0},passThroughOptions:(t=>{const e={...t};return delete e.dialogic,e})(e)}},N=t=>e=>(i={})=>{const{identityOptions:o,dialogicOptions:n,passThroughOptions:s}=C(e,i);return new Promise(r=>{const a={didShow:t=>(n.didShow&&n.didShow(t),r(t)),didHide:t=>(n.didHide&&n.didHide(t),r(t))},d={ns:t,identityOptions:o,dialogicOptions:n,callbacks:a,passThroughOptions:s,id:p(o,t),timer:n.timeout?A():void 0,key:(_===Number.MAX_VALUE?0:_++).toString(),transitionState:x},l=v.find(t,o);if(l.just&&n.toggle){const o=F(t)(e)(i);return r(o)}if(l.just&&!n.queued){const e=l.just,i=e.dialogicOptions,o={...d,transitionState:e.transitionState,dialogicOptions:i};w.replace(t,e.id,o)}else w.add(t,d);r(d)})},F=t=>e=>i=>{const{identityOptions:o,dialogicOptions:n,passThroughOptions:s}=C(e,i),r=v.find(t,o);if(r.just){const e=r.just,i={...e,dialogicOptions:{...e.dialogicOptions,...n},passThroughOptions:{...e.passThroughOptions,passThroughOptions:s}};return w.replace(t,e.id,i),i.transitionState!==q?K(i):Promise.resolve(i)}return Promise.resolve()},R=t=>e=>e=>{const i=$(t,e).filter(t=>!!t.timer);return i.forEach(t=>t.timer&&t.timer.actions.pause()),Promise.all(i)},M=t=>e=>e=>{const i=e||{},o={id:i.id,spawn:i.spawn},n=$(t,o).filter(t=>!!t.timer);return n.forEach(t=>t.timer&&t.timer.actions.resume(i.minimumDuration)),Promise.all(n)},H=(t,e)=>i=>o=>n=>{const s=(t=>e=>i=>v.find(t,k(e,i)))(i)(o)(n);return s.just&&s.just&&s.just.timer?s.just.timer.selectors[t]():e},L=H("isPaused",!1),V=H("getRemaining",void 0),B=t=>e=>e=>!!$(t,e).length,$=(t,e)=>{const o=v.getAll(t);let n;return n=e?i(I(e),(t=>e=>void 0!==t.id?e.filter(e=>e.identityOptions.id===t.id):e)(e))(o):o,n},U=t=>e=>e=>{const i=$(t,e),o=[];return i.forEach(t=>{t.timer&&t.timer.actions.abort(),o.push(t)}),e?o.forEach(e=>{w.remove(t,e.id)}):w.removeAll(t),Promise.resolve(o)},X=(t,e)=>({...t,dialogicOptions:{...t.dialogicOptions,...e}}),z=t=>e=>e=>{const i=e||{},o={id:i.id,spawn:i.spawn},n=$(t,o),s=n.filter(t=>!i.queued&&!t.dialogicOptions.queued),r=n.filter(t=>i.queued||t.dialogicOptions.queued),a=[];if(s.forEach(t=>a.push(K(X(t,i)))),r.length>0){const[e]=r;w.store(t,[e]),a.push(K(X(e,i)))}return Promise.all(a)},G=t=>e=>v.getCount(t,e),J=(t,e)=>u(t.dialogicOptions,e),K=async function(t){t.transitionState=q,t.timer&&t.timer.actions.stop(),await J(t,s),t.callbacks.didHide&&await t.callbacks.didHide(t);const e={...t};return w.remove(t.ns,t.id),Promise.resolve(e)},Q=({ns:t,queued:e,timeout:i})=>{const o="default_"+t,n="default_"+t,s={id:o,spawn:n,...e&&{queued:e},...void 0!==i&&{timeout:i}};return{ns:t,defaultId:o,defaultSpawn:n,defaultDialogicOptions:s,show:N(t)(s),hide:F(t)(s),hideAll:z(t)(s),resetAll:U(t)(s),pause:R(t)(s),resume:M(t)(s),exists:B(t)(s),getCount:G(t),isPaused:L(t)(s),getRemaining:V(t)(s)}},W=Q({ns:"dialog"}),Y=Q({ns:"notification",queued:!0,timeout:3e3});t.actions=w,t.dialog=W,t.dialogical=Q,t.exists=B,t.filterCandidates=(t,e,o)=>{const n=e[t]||[];return 0==n.length?[]:i(I(o),D)(n)},t.getCount=G,t.getRemaining=V,t.getTimerProperty=H,t.hide=F,t.hideAll=z,t.hideItem=K,t.isPaused=L,t.notification=Y,t.pause=R,t.remaining=t=>{let e,i=void 0,o=!1;const n=()=>{const s=t.instance.getRemaining();i!==s&&(i=void 0===s?s:t.roundToSeconds?Math.round(Math.max(s,0)/1e3):Math.max(s,0)),t.callback(i),t.instance.exists()?o||(e=window.requestAnimationFrame(n)):(window.cancelAnimationFrame(e),o=!0)};e=window.requestAnimationFrame(n)},t.resetAll=U,t.resume=M,t.selectors=v,t.setDomElement=(t,e)=>{e.dialogicOptions.domElement=t},t.show=N,t.showItem=async function(t){return t.transitionState!==j&&(t.transitionState=j,await J(t,n)),t.callbacks.didShow&&await t.callbacks.didShow(t),t.dialogicOptions.timeout&&t.timer&&await async function(t,e,i){return e.actions.start(()=>K(t),i),H("getResultPromise",void 0)}(t,t.timer,t.dialogicOptions.timeout),Promise.resolve(t)},t.states=f,Object.defineProperty(t,"__esModule",{value:!0})}));
