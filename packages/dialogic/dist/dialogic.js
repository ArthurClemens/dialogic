!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mithril/stream")):"function"==typeof define&&define.amd?define(["exports","mithril/stream"],t):t((i="undefined"!=typeof globalThis?globalThis:i||self).dialogic={},i.Stream)}(this,(function(i,t){"use strict";function e(i){return i&&"object"==typeof i&&"default"in i?i:{default:i}}var s=e(t);function n(i,t,e,s){return new(e||(e=Promise))((function(n,o){function a(i){try{d(s.next(i))}catch(i){o(i)}}function r(i){try{d(s.throw(i))}catch(i){o(i)}}function d(i){var t;i.done?n(i.value):(t=i.value,t instanceof e?t:new e((function(i){i(t)}))).then(a,r)}d((s=s.apply(i,t||[])).next())}))}const o=(i,t)=>{const e=((i,t)=>t.find(t=>t.id===i))(i,t);return e?t.indexOf(e):-1},a=(i,t)=>[t,i.id,i.spawn].filter(Boolean).join("-"),r={initialState:{store:{}},actions:i=>({add:(t,e)=>{i(s=>{const n=s.store[t]||[];return s.store[t]=[...n,e],e.timer&&e.timer.states.map(()=>r.actions(i).refresh()),s})},remove:(t,e)=>{i(i=>{const s=i.store[t]||[],n=((i,t)=>{const e=o(i,t);return-1!==e&&t.splice(e,1),t})(e,s);return i.store[t]=n,i})},replace:(t,e,s)=>{i(i=>{const n=i.store[t]||[];if(n){const a=o(e,n);-1!==a&&(n[a]=s,i.store[t]=[...n])}return i})},removeAll:t=>{i(i=>(i.store[t]=[],i))},store:(t,e)=>{i(i=>(i.store[t]=[...e],i))},refresh:()=>{i(i=>Object.assign({},i))}}),selectors:i=>{const t={getStore:()=>i().store,find:(t,e)=>{const s=i().store[t]||[],n=a(e,t),o=s.find(i=>i.id===n);return o?{just:o}:{nothing:void 0}},getAll:(t,e)=>{const s=i().store[t]||[],n=void 0!==e?e.spawn:void 0,o=void 0!==e?e.id:void 0,a=void 0!==n?s.filter(i=>i.identityOptions.spawn===n):s;return void 0!==o?a.filter(i=>i.identityOptions.id===o):a},getCount:(i,e)=>t.getAll(i,e).length};return t}},d=s.default(),l=s.default.scan((i,t)=>t(i),Object.assign({},r.initialState),d),c=Object.assign({},r.actions(d)),u=Object.assign({},r.selectors(l)),m={callback:()=>{},isPaused:!1,onAbort:()=>{},onDone:()=>{},promise:void 0,remaining:void 0,startTime:void 0,timeoutFn:()=>{},timerId:void 0},g=i=>(window.clearTimeout(i.timerId),{timerId:m.timerId}),p=i=>Object.assign(Object.assign({},g(i)),{isPaused:!0,remaining:f(i)}),f=i=>0===i.remaining||void 0===i.remaining?i.remaining:i.remaining-((new Date).getTime()-(i.startTime||0)),h=()=>{const i={initialState:m,actions:t=>({start:(e,s)=>{t(n=>Object.assign(Object.assign(Object.assign(Object.assign({},n),g(n)),((i,t,e,s)=>{const n=()=>{t(),i.onDone(),s()};return Object.assign({timeoutFn:n,promise:new Promise(t=>{i.onDone=()=>t(),i.onAbort=()=>t()})},i.isPaused?{}:{startTime:(new Date).getTime(),timerId:window.setTimeout(n,e),remaining:e})})(n,e,s,()=>i.actions(t).done())),n.isPaused&&p(n)))},stop:()=>{t(i=>Object.assign(Object.assign(Object.assign({},i),(i=>Object.assign({},g(i)))(i)),m))},pause:()=>{t(i=>Object.assign(Object.assign({},i),!i.isPaused&&p(i)))},resume:i=>{t(t=>Object.assign(Object.assign({},t),t.isPaused&&((i,t)=>{window.clearTimeout(i.timerId);const e=t?Math.max(i.remaining||0,t):i.remaining;return{startTime:(new Date).getTime(),isPaused:!1,remaining:e,timerId:window.setTimeout(i.timeoutFn,e)}})(t,i)))},abort:()=>{t(i=>(i.onAbort(),Object.assign(Object.assign({},i),g(i))))},refresh:()=>{t(i=>Object.assign({},i))},done:()=>{t(()=>m)}}),selectors:i=>({isPaused:()=>i().isPaused,getRemaining:()=>{const t=i();return t.isPaused?t.remaining:f(t)},getResultPromise:()=>i().promise})},t=s.default(),e=s.default.scan((i,t)=>t(i),Object.assign({},i.initialState),t);return{states:e,actions:Object.assign({},i.actions(t)),selectors:Object.assign({},i.selectors(e))}},O=(...i)=>t=>i.filter(Boolean).reduce((i,t)=>t(i),t),w=({domElement:i,prop:t})=>{const e=document.defaultView;if(e){const s=e.getComputedStyle(i);if(s)return s.getPropertyValue(t)}},b="show",v="hide",j=(i,t,e)=>{const s=e[t];s&&Object.keys(s).forEach(t=>{const e=s[t];i.style[t]=e})},S=(i,t)=>i.split(/ /).map(i=>`${i}-${t}`),y=(i,t,e,s)=>{if(t.styles){const n=((i,t)=>("function"==typeof t?t(i):t)||{})(i,t.styles);j(i,"default",n),s&&(i=>{i.style.transitionDuration="0ms"})(i),j(i,e,n)}if(t.className){const s={showStart:S(t.className,"show-start"),showEnd:S(t.className,"show-end"),hideStart:S(t.className,"hide-start"),hideEnd:S(t.className,"hide-end")};((i,t)=>{i.classList.remove(...t.showStart,...t.showEnd,...t.hideStart,...t.hideEnd)})(i,s),s&&i.classList.add(...s[e])}i.scrollTop},P=i=>{const t=parseFloat(i)*(-1===i.indexOf("ms")?1e3:1);return Number.isNaN(t)?0:t},T={showStart:{nextStep:"showEnd"},showEnd:{nextStep:void 0},hideStart:{nextStep:"hideEnd"},hideEnd:{nextStep:void 0}},E=(i,t)=>{const{domElement:e}=i;if(!e)return Promise.resolve("no domElement");clearTimeout(i.__transitionTimeoutId__);let s=t===b?"showStart":"hideStart";return new Promise(t=>{y(e,i,s,"showStart"===s),setTimeout(()=>{const{nextStep:n}=T[s];if(n){s=n,y(e,i,s);const o=(i=>{const t=w({domElement:i,prop:"transition-duration"}),e=void 0!==t?P(t):0,s=w({domElement:i,prop:"transition-delay"});return e+(void 0!==s?P(s):0)})(e);i.__transitionTimeoutId__=window.setTimeout(t,o)}},0)})},_={uid:0};var x;!function(i){i[i.Default=0]="Default",i[i.Displaying=1]="Displaying",i[i.Hiding=2]="Hiding"}(x||(x={}));const D=i=>t=>e=>u.find(i,q(t,e)),A=i=>t=>void 0!==i.spawn?t.filter(t=>t.identityOptions.spawn===i.spawn):t,k=i=>{let t=0;return i.map(i=>({item:i,queueCount:i.dialogicOptions.queued?t++:0})).filter(({queueCount:i})=>0===i).map(({item:i})=>i)},q=(i,t={})=>({id:t.id||i.id,spawn:t.spawn||i.spawn}),H=(i,t={})=>{const e={id:t.dialogic?t.dialogic.id:void 0,spawn:t.dialogic?t.dialogic.spawn:void 0};return{identityOptions:q(i||{},e),dialogicOptions:Object.assign(Object.assign(Object.assign({},i),t.dialogic),{__transitionTimeoutId__:0}),passThroughOptions:(i=>{const t=Object.assign({},i);return delete t.dialogic,t})(t)}},I=i=>t=>e=>{const{identityOptions:s,dialogicOptions:n,passThroughOptions:o}=H(t,e);return new Promise(r=>{const d={willShow:i=>(n.willShow&&n.willShow(i),r(i)),willHide:i=>(n.willHide&&n.willHide(i),r(i)),didShow:i=>(n.didShow&&n.didShow(i),r(i)),didHide:i=>(n.didHide&&n.didHide(i),r(i))},l={ns:i,identityOptions:s,dialogicOptions:n,callbacks:d,passThroughOptions:o,id:a(s,i),timer:n.timeout?h():void 0,key:(_.uid===Number.MAX_VALUE?_.uid=0:_.uid+=1,_.uid).toString(),transitionState:x.Default},m=u.find(i,s).just;if(m&&n.toggle)return N(i)(t)(e),r(m);if(m&&!n.queued){const t=Object.assign(Object.assign({},l),{key:m.key,transitionState:m.transitionState,dialogicOptions:m.dialogicOptions});c.replace(i,m.id,t)}else c.add(i,l);r(l)})},N=i=>t=>e=>{const{identityOptions:s,dialogicOptions:n,passThroughOptions:o}=H(t,e),a=u.find(i,s).just;if(a){const t=Object.assign(Object.assign({},a),{dialogicOptions:Object.assign(Object.assign({},a.dialogicOptions),n),passThroughOptions:Object.assign(Object.assign({},a.passThroughOptions),{passThroughOptions:o})});return c.replace(i,a.id,t),t.transitionState!==x.Hiding?K(t):Promise.resolve(t)}return Promise.resolve({ns:i,id:s.id})},C=i=>t=>t=>{const e=B(i,t).filter(i=>!!i.timer);return e.forEach(i=>{i.timer&&i.timer.actions.pause()}),Promise.all(e)},F=i=>t=>t=>{const e=t||{},s={id:e.id,spawn:e.spawn},n=B(i,s).filter(i=>!!i.timer);return n.forEach(i=>{i.timer&&i.timer.actions.resume(e.minimumDuration)}),Promise.all(n)},R=(i,t,e)=>{var s,n;const o=D(i)(t)(e);return null===(n=null===(s=null==o?void 0:o.just)||void 0===s?void 0:s.timer)||void 0===n?void 0:n.selectors},M=i=>t=>e=>{var s;return(null===(s=R(i,t,e))||void 0===s?void 0:s.isPaused())||!1},L=i=>t=>e=>{var s;return(null===(s=R(i,t,e))||void 0===s?void 0:s.getRemaining())||void 0},V=i=>t=>t=>!!B(i,t).length,B=(i,t)=>{const e=u.getAll(i);let s;return s=t?O(A(t),(i=>t=>void 0!==i.id?t.filter(t=>t.identityOptions.id===i.id):t)(t))(e):e,s},$=i=>t=>t=>{const e=B(i,t),s=[];return e.forEach(i=>{i.timer&&i.timer.actions.abort(),s.push(i)}),t?s.forEach(t=>{c.remove(i,t.id)}):c.removeAll(i),Promise.resolve(s)},z=(i,t)=>Object.assign(Object.assign({},i),{dialogicOptions:Object.assign(Object.assign({},i.dialogicOptions),t)}),U=i=>t=>t=>{const e=t||{},s={id:e.id,spawn:e.spawn},n=B(i,s),o=n.filter(i=>!e.queued&&!i.dialogicOptions.queued),a=n.filter(i=>e.queued||i.dialogicOptions.queued),r=[];if(o.forEach(i=>r.push(K(z(i,e)))),a.length>0){const[t]=a;c.store(i,[t]),r.push(K(z(t,e)))}return Promise.all(r)},X=i=>t=>u.getCount(i,t),G=(i,t)=>E(i.dialogicOptions,t),J=(i,t,e)=>n(void 0,void 0,void 0,(function*(){return t.actions.start(()=>K(i),e),i=>t=>e=>{const s=D(i)(t)(e);if(s.just)return s.just&&s.just.timer?s.just.timer.selectors.getResultPromise():void 0}})),K=i=>n(void 0,void 0,void 0,(function*(){i.transitionState=x.Hiding,i.timer&&i.timer.actions.stop(),i.callbacks.willHide&&i.callbacks.willHide(i),yield G(i,v),i.callbacks.didHide&&i.callbacks.didHide(i);const t=Object.assign({},i);return c.remove(i.ns,i.id),Promise.resolve(t)})),Q=({ns:i,queued:t,timeout:e})=>{const s="default_"+i,n="default_"+i,o=Object.assign(Object.assign({id:s,spawn:n},t&&{queued:t}),void 0!==e&&{timeout:e});return{ns:i,defaultId:s,defaultSpawn:n,defaultDialogicOptions:o,show:I(i)(o),hide:N(i)(o),hideAll:U(i)(o),resetAll:$(i)(o),pause:C(i)(o),resume:F(i)(o),exists:V(i)(o),getCount:X(i),isPaused:M(i)(o),getRemaining:L(i)(o)}},W=Q({ns:"dialog"}),Y=Q({ns:"notification",queued:!0,timeout:3e3});var Z=Object.freeze({__proto__:null});i.Dialogic=Z,i.actions=c,i.dialog=W,i.dialogical=Q,i.exists=V,i.filterCandidates=(i,t,e)=>{const s=t[i]||[];return 0===s.length?[]:O(A(e),k)(s)},i.getCount=X,i.getRemaining=L,i.hide=N,i.hideAll=U,i.hideItem=K,i.isPaused=M,i.notification=Y,i.pause=C,i.remaining=i=>{let t,e,s=!1;const n={id:i.id,spawn:i.spawn},o=()=>{const a=i.instance.getRemaining(n);t!==a&&(t=void 0===a?a:i.roundToSeconds?Math.round(Math.max(a,0)/1e3):Math.max(a,0)),i.callback(t),i.instance.exists(n)?s||(e=window.requestAnimationFrame(o)):(window.cancelAnimationFrame(e),s=!0)};e=window.requestAnimationFrame(o)},i.resetAll=$,i.resume=F,i.selectors=u,i.setDomElement=(i,t)=>{t.dialogicOptions.domElement=i},i.show=I,i.showItem=i=>n(void 0,void 0,void 0,(function*(){return i.callbacks.willShow&&i.callbacks.willShow(i),i.transitionState!==x.Displaying&&(i.transitionState=x.Displaying,yield G(i,b)),i.callbacks.didShow&&i.callbacks.didShow(i),i.dialogicOptions.timeout&&i.timer&&(yield J(i,i.timer,i.dialogicOptions.timeout)),Promise.resolve(i)})),i.states=l,Object.defineProperty(i,"__esModule",{value:!0})}));
//# sourceMappingURL=dialogic.js.map
