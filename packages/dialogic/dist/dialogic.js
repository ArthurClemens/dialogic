!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("mithril/stream")):"function"==typeof define&&define.amd?define(["exports","mithril/stream"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).dialogic={},t.Stream)}(this,(function(t,i){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=e(i);function n(t,i,e,s){return new(e||(e=Promise))((function(n,o){function a(t){try{d(s.next(t))}catch(t){o(t)}}function r(t){try{d(s.throw(t))}catch(t){o(t)}}function d(t){var i;t.done?n(t.value):(i=t.value,i instanceof e?i:new e((function(t){t(i)}))).then(a,r)}d((s=s.apply(t,i||[])).next())}))}const o=(...t)=>i=>t.filter(Boolean).reduce((t,i)=>i(t),i),a=({domElement:t,prop:i})=>{const e=document.defaultView;if(e){const s=e.getComputedStyle(t);if(s)return s.getPropertyValue(i)}},r="show",d="hide",l=(t,i,e)=>{const s=e[i]||{};Object.keys(s).forEach(i=>{const e=s[i].toString();t.style[i]=e})},c=(t,i)=>t.split(/ /).map(t=>`${t}-${i}`),u=(t,i,e,s)=>{if(i.styles){const n=((t,i)=>("function"==typeof i?i(t):i)||{})(t,i.styles);l(t,"default",n),s&&(t=>{t.style.transitionDuration="0ms"})(t),l(t,e,n)}if(i.className){const s={showStart:c(i.className,"show-start"),showEnd:c(i.className,"show-end"),hideStart:c(i.className,"hide-start"),hideEnd:c(i.className,"hide-end")};((t,i)=>{t.classList.remove(...i.showStart,...i.showEnd,...i.hideStart,...i.hideEnd)})(t,s),s&&t.classList.add(...s[e])}t.scrollTop},m={showStart:{nextStep:"showEnd"},showEnd:{nextStep:void 0},hideStart:{nextStep:"hideEnd"},hideEnd:{nextStep:void 0}},g=(t,i)=>{const e=t.domElement;if(!e)return Promise.resolve("no domElement");clearTimeout(t.__transitionTimeoutId__);let s=i===r?"showStart":"hideStart";return new Promise(i=>{u(e,t,s,"showStart"===s),setTimeout(()=>{const n=m[s].nextStep;if(n){s=n,u(e,t,s);const o=(t=>{const i=a({domElement:t,prop:"transition-duration"}),e=void 0!==i?p(i):0,s=a({domElement:t,prop:"transition-delay"});return e+(void 0!==s?p(s):0)})(e);t.__transitionTimeoutId__=window.setTimeout(i,o)}},0)})},p=t=>{const i=parseFloat(t)*(-1===t.indexOf("ms")?1e3:1);return isNaN(i)?0:i},f=(t,i)=>{const e=((t,i)=>i.find(i=>i.id===t))(t,i);return e?i.indexOf(e):-1},h=(t,i)=>[i,t.id,t.spawn].filter(Boolean).join("-"),O={initialState:{store:{}},actions:t=>({add:(i,e)=>{t(s=>{const n=s.store[i]||[];return s.store[i]=[...n,e],e.timer&&e.timer.states.map(()=>O.actions(t).refresh()),s})},remove:(i,e)=>{t(t=>{const s=t.store[i]||[],n=((t,i)=>{const e=f(t,i);return-1!==e&&i.splice(e,1),i})(e,s);return t.store[i]=n,t})},replace:(i,e,s)=>{t(t=>{const n=t.store[i]||[];if(n){const o=f(e,n);-1!==o&&(n[o]=s,t.store[i]=[...n])}return t})},removeAll:i=>{t(t=>(t.store[i]=[],t))},store:(i,e)=>{t(t=>(t.store[i]=[...e],t))},refresh:()=>{t(t=>Object.assign({},t))}}),selectors:t=>{const i={getStore:()=>t().store,find:(i,e)=>{const s=t().store[i]||[],n=h(e,i),o=s.find(t=>t.id===n);return o?{just:o}:{nothing:void 0}},getAll:(i,e)=>{const s=t().store[i]||[],n=void 0!==e?e.spawn:void 0,o=void 0!==e?e.id:void 0,a=void 0!==n?s.filter(t=>t.identityOptions.spawn===n):s;return void 0!==o?a.filter(t=>t.identityOptions.id===o):a},getCount:(t,e)=>i.getAll(t,e).length};return i}},w=s.default(),b=s.default.scan((t,i)=>i(t),Object.assign({},O.initialState),w),v=Object.assign({},O.actions(w)),j=Object.assign({},O.selectors(b)),S={callback:()=>{},isPaused:!1,onAbort:()=>{},onDone:()=>{},promise:void 0,remaining:void 0,startTime:void 0,timeoutFn:()=>{},timerId:void 0},y=t=>(window.clearTimeout(t.timerId),{timerId:S.timerId}),P=t=>Object.assign(Object.assign({},y(t)),{isPaused:!0,remaining:T(t)}),T=t=>0===t.remaining||void 0===t.remaining?t.remaining:t.remaining-((new Date).getTime()-(t.startTime||0)),E=()=>{const t={initialState:S,actions:i=>({start:(e,s)=>{i(n=>Object.assign(Object.assign(Object.assign(Object.assign({},n),y(n)),((t,i,e,s)=>{const n=()=>{i(),t.onDone(),s()};return Object.assign({timeoutFn:n,promise:new Promise(i=>{t.onDone=()=>i(),t.onAbort=()=>i()})},t.isPaused?{}:{startTime:(new Date).getTime(),timerId:window.setTimeout(n,e),remaining:e})})(n,e,s,()=>t.actions(i).done())),n.isPaused&&P(n)))},stop:()=>{i(t=>Object.assign(Object.assign(Object.assign({},t),(t=>Object.assign({},y(t)))(t)),S))},pause:()=>{i(t=>Object.assign(Object.assign({},t),!t.isPaused&&P(t)))},resume:t=>{i(i=>Object.assign(Object.assign({},i),i.isPaused&&((t,i)=>{window.clearTimeout(t.timerId);const e=i?Math.max(t.remaining||0,i):t.remaining;return{startTime:(new Date).getTime(),isPaused:!1,remaining:e,timerId:window.setTimeout(t.timeoutFn,e)}})(i,t)))},abort:()=>{i(t=>(t.onAbort(),Object.assign(Object.assign({},t),y(t))))},done:()=>{i(()=>S)},refresh:()=>{i(t=>Object.assign({},t))}}),selectors:t=>({isPaused:()=>t().isPaused,getRemaining:()=>{const i=t();return i.isPaused?i.remaining:T(i)},getResultPromise:()=>t().promise})},i=s.default(),e=s.default.scan((t,i)=>i(t),Object.assign({},t.initialState),i);return{states:e,actions:Object.assign({},t.actions(i)),selectors:Object.assign({},t.selectors(e))}};let _=0;var x;!function(t){t[t.Default=0]="Default",t[t.Displaying=1]="Displaying",t[t.Hiding=2]="Hiding"}(x||(x={}));const D=t=>i=>e=>j.find(t,q(i,e)),A=t=>i=>void 0!==t.spawn?i.filter(i=>i.identityOptions.spawn===t.spawn):i,k=t=>{let i=0;return t.map(t=>({item:t,queueCount:t.dialogicOptions.queued?i++:0})).filter(({queueCount:t})=>0===t).map(({item:t})=>t)},q=(t,i={})=>({id:i.id||t.id,spawn:i.spawn||t.spawn}),H=(t,i={})=>{const e={id:i.dialogic?i.dialogic.id:void 0,spawn:i.dialogic?i.dialogic.spawn:void 0};return{identityOptions:q(t||{},e),dialogicOptions:Object.assign(Object.assign(Object.assign({},t),i.dialogic),{__transitionTimeoutId__:0}),passThroughOptions:(t=>{const i=Object.assign({},t);return delete i.dialogic,i})(i)}},I=t=>i=>(e={})=>{const{identityOptions:s,dialogicOptions:n,passThroughOptions:o}=H(i,e);return new Promise(a=>{const r={willShow:t=>(n.willShow&&n.willShow(t),a(t)),willHide:t=>(n.willHide&&n.willHide(t),a(t)),didShow:t=>(n.didShow&&n.didShow(t),a(t)),didHide:t=>(n.didHide&&n.didHide(t),a(t))},d={ns:t,identityOptions:s,dialogicOptions:n,callbacks:r,passThroughOptions:o,id:h(s,t),timer:n.timeout?E():void 0,key:(_===Number.MAX_VALUE?0:_++).toString(),transitionState:x.Default},l=j.find(t,s).just;if(l&&n.toggle)return C(t)(i)(e),a(l);if(l&&!n.queued){const i=l.dialogicOptions,e=Object.assign(Object.assign({},d),{key:l.key,transitionState:l.transitionState,dialogicOptions:i});v.replace(t,l.id,e)}else v.add(t,d);a(d)})},C=t=>i=>e=>{const{identityOptions:s,dialogicOptions:n,passThroughOptions:o}=H(i,e),a=j.find(t,s).just;if(a){const i=Object.assign(Object.assign({},a),{dialogicOptions:Object.assign(Object.assign({},a.dialogicOptions),n),passThroughOptions:Object.assign(Object.assign({},a.passThroughOptions),{passThroughOptions:o})});return v.replace(t,a.id,i),i.transitionState!==x.Hiding?K(i):Promise.resolve(i)}return Promise.resolve({ns:t,id:s.id})},N=t=>i=>i=>{const e=$(t,i).filter(t=>!!t.timer);return e.forEach(t=>{t.timer&&t.timer.actions.pause()}),Promise.all(e)},F=t=>i=>i=>{const e=i||{},s={id:e.id,spawn:e.spawn},n=$(t,s).filter(t=>!!t.timer);return n.forEach(t=>{t.timer&&t.timer.actions.resume(e.minimumDuration)}),Promise.all(n)},R=(t,i)=>e=>s=>n=>{const o=D(e)(s)(n);return o.just&&o.just&&o.just.timer?o.just.timer.selectors[t]():i},M=(t,i,e)=>{var s,n;const o=D(t)(i)(e);return null===(n=null===(s=null==o?void 0:o.just)||void 0===s?void 0:s.timer)||void 0===n?void 0:n.selectors},L=t=>i=>e=>{var s;return(null===(s=M(t,i,e))||void 0===s?void 0:s.isPaused())||!1},V=t=>i=>e=>{var s;return(null===(s=M(t,i,e))||void 0===s?void 0:s.getRemaining())||void 0},B=t=>i=>i=>!!$(t,i).length,$=(t,i)=>{const e=j.getAll(t);let s;return s=i?o(A(i),(t=>i=>void 0!==t.id?i.filter(i=>i.identityOptions.id===t.id):i)(i))(e):e,s},z=t=>i=>i=>{const e=$(t,i),s=[];return e.forEach(t=>{t.timer&&t.timer.actions.abort(),s.push(t)}),i?s.forEach(i=>{v.remove(t,i.id)}):v.removeAll(t),Promise.resolve(s)},U=(t,i)=>Object.assign(Object.assign({},t),{dialogicOptions:Object.assign(Object.assign({},t.dialogicOptions),i)}),X=t=>i=>i=>{const e=i||{},s={id:e.id,spawn:e.spawn},n=$(t,s),o=n.filter(t=>!e.queued&&!t.dialogicOptions.queued),a=n.filter(t=>e.queued||t.dialogicOptions.queued),r=[];if(o.forEach(t=>r.push(K(U(t,e)))),a.length>0){const[i]=a;v.store(t,[i]),r.push(K(U(i,e)))}return Promise.all(r)},G=t=>i=>j.getCount(t,i),J=(t,i)=>g(t.dialogicOptions,i),K=t=>n(void 0,void 0,void 0,(function*(){t.transitionState=x.Hiding,t.timer&&t.timer.actions.stop(),t.callbacks.willHide&&t.callbacks.willHide(t),yield J(t,d),t.callbacks.didHide&&t.callbacks.didHide(t);const i=Object.assign({},t);return v.remove(t.ns,t.id),Promise.resolve(i)})),Q=({ns:t,queued:i,timeout:e})=>{const s="default_"+t,n="default_"+t,o=Object.assign(Object.assign({id:s,spawn:n},i&&{queued:i}),void 0!==e&&{timeout:e});return{ns:t,defaultId:s,defaultSpawn:n,defaultDialogicOptions:o,show:I(t)(o),hide:C(t)(o),hideAll:X(t)(o),resetAll:z(t)(o),pause:N(t)(o),resume:F(t)(o),exists:B(t)(o),getCount:G(t),isPaused:L(t)(o),getRemaining:V(t)(o)}},W=Q({ns:"dialog"}),Y=Q({ns:"notification",queued:!0,timeout:3e3});var Z=Object.freeze({__proto__:null});t.Dialogic=Z,t.actions=v,t.dialog=W,t.dialogical=Q,t.exists=B,t.filterCandidates=(t,i,e)=>{const s=i[t]||[];return 0==s.length?[]:o(A(e),k)(s)},t.getCount=G,t.getRemaining=V,t.getTimerProperty=R,t.hide=C,t.hideAll=X,t.hideItem=K,t.isPaused=L,t.notification=Y,t.pause=N,t.remaining=t=>{let i,e,s=!1;const n={id:t.id,spawn:t.spawn},o=()=>{const a=t.instance.getRemaining(n);i!==a&&(i=void 0===a?a:t.roundToSeconds?Math.round(Math.max(a,0)/1e3):Math.max(a,0)),t.callback(i),t.instance.exists(n)?s||(e=window.requestAnimationFrame(o)):(window.cancelAnimationFrame(e),s=!0)};e=window.requestAnimationFrame(o)},t.resetAll=z,t.resume=F,t.selectors=j,t.setDomElement=(t,i)=>{i.dialogicOptions.domElement=t},t.show=I,t.showItem=function(t){return n(this,void 0,void 0,(function*(){return t.callbacks.willShow&&t.callbacks.willShow(t),t.transitionState!==x.Displaying&&(t.transitionState=x.Displaying,yield J(t,r)),t.callbacks.didShow&&t.callbacks.didShow(t),t.dialogicOptions.timeout&&t.timer&&(yield function(t,i,e){return n(this,void 0,void 0,(function*(){return i.actions.start(()=>K(t),e),R("getResultPromise",void 0)}))}(t,t.timer,t.dialogicOptions.timeout)),Promise.resolve(t)}))},t.states=b,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=dialogic.js.map
