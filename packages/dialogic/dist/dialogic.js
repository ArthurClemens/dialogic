!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("mithril/stream")):"function"==typeof define&&define.amd?define(["exports","mithril/stream"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).dialogic={},t.Stream)}(this,(function(t,e){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=i(e);const n=(...t)=>e=>t.filter(Boolean).reduce((t,e)=>e(t),e),s=({domElement:t,prop:e})=>{const i=document.defaultView;if(i){const o=i.getComputedStyle(t);if(o)return o.getPropertyValue(e)}},r="show",a="hide",d=(t,e,i)=>{const o=i[e]||{};Object.keys(o).forEach(e=>{const i=o[e].toString();t.style[e]=i})},l=(t,e)=>t.split(/ /).map(t=>`${t}-${e}`),u=(t,e,i,o)=>{if(e.styles){const n=((t,e)=>("function"==typeof e?e(t):e)||{})(t,e.styles);d(t,"default",n),o&&(t=>{t.style.transitionDuration="0ms"})(t),d(t,i,n)}if(e.className){const o={showStart:l(e.className,"show-start"),showEnd:l(e.className,"show-end"),hideStart:l(e.className,"hide-start"),hideEnd:l(e.className,"hide-end")};((t,e)=>{t.classList.remove(...e.showStart,...e.showEnd,...e.hideStart,...e.hideEnd)})(t,o),o&&t.classList.add(...o[i])}t.scrollTop},c={showStart:{nextStep:"showEnd"},showEnd:{nextStep:void 0},hideStart:{nextStep:"hideEnd"},hideEnd:{nextStep:void 0}},m=(t,e)=>{const i=t.domElement;if(!i)return Promise.resolve("no domElement");clearTimeout(t.__transitionTimeoutId__);let o=e===r?"showStart":"hideStart";return new Promise(e=>{u(i,t,o,"showStart"===o),setTimeout(()=>{const n=c[o].nextStep;if(n){o=n,u(i,t,o);const r=(t=>{const e=s({domElement:t,prop:"transition-duration"}),i=void 0!==e?p(e):0,o=s({domElement:t,prop:"transition-delay"});return i+(void 0!==o?p(o):0)})(i);t.__transitionTimeoutId__=setTimeout(e,r)}},0)})},p=t=>{const e=parseFloat(t)*(-1===t.indexOf("ms")?1e3:1);return isNaN(e)?0:e},g=(t,e)=>{const i=((t,e)=>e.find(e=>e.id===t))(t,e);return e.indexOf(i)},h=(t,e)=>[e,t.id,t.spawn].filter(Boolean).join("-"),w={initialState:{store:{}},actions:t=>({add:(e,i)=>{t(o=>{const n=o.store[e]||[];return o.store[e]=[...n,i],i.timer&&i.timer.states.map(()=>w.actions(t).refresh()),o})},remove:(e,i)=>{t(t=>{const o=t.store[e]||[],n=((t,e)=>{const i=g(t,e);return-1!==i&&e.splice(i,1),e})(i,o);return t.store[e]=n,t})},replace:(e,i,o)=>{t(t=>{const n=t.store[e]||[];if(n){const s=g(i,n);-1!==s&&(n[s]=o,t.store[e]=[...n])}return t})},removeAll:e=>{t(t=>(t.store[e]=[],t))},store:(e,i)=>{t(t=>(t.store[e]=[...i],t))},refresh:()=>{t(t=>({...t}))}}),selectors:t=>{const e={getStore:()=>t().store,find:(e,i)=>{const o=t().store[e]||[],n=h(i,e),s=o.find(t=>t.id===n);return s?{just:s}:{nothing:void 0}},getAll:(e,i)=>{const o=t().store[e]||[],n=void 0!==i?i.spawn:void 0,s=void 0!==i?i.id:void 0,r=void 0!==n?o.filter(t=>t.identityOptions.spawn===n):o;return void 0!==s?r.filter(t=>t.identityOptions.id===s):r},getCount:(t,i)=>e.getAll(t,i).length};return e}},f=o.default(),S=o.default.scan((t,e)=>e(t),{...w.initialState},f),v={...w.actions(f)},O={...w.selectors(S)},y={callback:()=>{},isPaused:!1,onAbort:()=>{},onDone:()=>{},promise:void 0,remaining:void 0,startTime:void 0,timeoutFn:()=>{},timerId:void 0},P=(t,e,i,o)=>{const n=()=>{e(),t.onDone(),o()};return{timeoutFn:n,promise:new Promise(e=>{t.onDone=()=>e(),t.onAbort=()=>e()}),...t.isPaused?{}:{startTime:(new Date).getTime(),timerId:window.setTimeout(n,i),remaining:i}}},T=t=>(window.clearTimeout(t.timerId),{timerId:y.timerId}),b=t=>({...T(t)}),E=t=>({...T(t),isPaused:!0,remaining:_(t)}),A=(t,e)=>{window.clearTimeout(t.timerId);const i=e?Math.max(t.remaining||0,e):t.remaining;return{startTime:(new Date).getTime(),isPaused:!1,remaining:i,timerId:window.setTimeout(t.timeoutFn,i)}},_=t=>0===t.remaining||void 0===t.remaining?t.remaining:t.remaining-((new Date).getTime()-(t.startTime||0)),x=()=>{const t={initialState:y,actions:e=>({start:(i,o)=>{e(n=>({...n,...T(n),...P(n,i,o,()=>t.actions(e).done()),...n.isPaused&&E(n)}))},stop:()=>{e(t=>({...t,...b(t),...y}))},pause:()=>{e(t=>({...t,...!t.isPaused&&E(t)}))},resume:t=>{e(e=>({...e,...e.isPaused&&A(e,t)}))},abort:()=>{e(t=>(t.onAbort(),{...t,...T(t)}))},done:()=>{e(t=>y)},refresh:()=>{e(t=>({...t}))}}),selectors:t=>({isPaused:()=>t().isPaused,getRemaining:()=>{const e=t();return e.isPaused?e.remaining:_(e)},getResultPromise:()=>t().promise})},e=o.default(),i=o.default.scan((t,e)=>e(t),{...t.initialState},e);return{states:i,actions:{...t.actions(e)},selectors:{...t.selectors(i)}}};let j=0;const k=0,q=1,I=2,D=t=>e=>void 0!==t.spawn?e.filter(e=>e.identityOptions.spawn===t.spawn):e,H=t=>{let e=0;return t.map(t=>({item:t,queueCount:t.dialogicOptions.queued?e++:0})).filter(({queueCount:t})=>0===t).map(({item:t})=>t)},C=(t,e={})=>({id:e.id||t.id,spawn:e.spawn||t.spawn}),N=(t,e={})=>{const i={id:e.dialogic?e.dialogic.id:void 0,spawn:e.dialogic?e.dialogic.spawn:void 0};return{identityOptions:C(t||{},i),dialogicOptions:{...t,...e.dialogic,__transitionTimeoutId__:0},passThroughOptions:(t=>{const e={...t};return delete e.dialogic,e})(e)}},F=t=>e=>(i={})=>{const{identityOptions:o,dialogicOptions:n,passThroughOptions:s}=N(e,i);return new Promise(r=>{const a={willShow:t=>(n.willShow&&n.willShow(t),r(t)),willHide:t=>(n.willHide&&n.willHide(t),r(t)),didShow:t=>(n.didShow&&n.didShow(t),r(t)),didHide:t=>(n.didHide&&n.didHide(t),r(t))},d={ns:t,identityOptions:o,dialogicOptions:n,callbacks:a,passThroughOptions:s,id:h(o,t),timer:n.timeout?x():void 0,key:(j===Number.MAX_VALUE?0:j++).toString(),transitionState:k},l=O.find(t,o);if(l.just&&n.toggle){const o=R(t)(e)(i);return r(o)}if(l.just&&!n.queued){const e=l.just,i=e.dialogicOptions,o={...d,key:e.key,transitionState:e.transitionState,dialogicOptions:i};v.replace(t,e.id,o)}else v.add(t,d);r(d)})},R=t=>e=>i=>{const{identityOptions:o,dialogicOptions:n,passThroughOptions:s}=N(e,i),r=O.find(t,o);if(r.just){const e=r.just,i={...e,dialogicOptions:{...e.dialogicOptions,...n},passThroughOptions:{...e.passThroughOptions,passThroughOptions:s}};return v.replace(t,e.id,i),i.transitionState!==I?W(i):Promise.resolve(i)}return Promise.resolve()},M=t=>e=>e=>{const i=X(t,e).filter(t=>!!t.timer);return i.forEach(t=>t.timer&&t.timer.actions.pause()),Promise.all(i)},L=t=>e=>e=>{const i=e||{},o={id:i.id,spawn:i.spawn},n=X(t,o).filter(t=>!!t.timer);return n.forEach(t=>t.timer&&t.timer.actions.resume(i.minimumDuration)),Promise.all(n)},V=(t,e)=>i=>o=>n=>{const s=(t=>e=>i=>O.find(t,C(e,i)))(i)(o)(n);return s.just&&s.just&&s.just.timer?s.just.timer.selectors[t]():e},B=V("isPaused",!1),$=V("getRemaining",void 0),U=t=>e=>e=>!!X(t,e).length,X=(t,e)=>{const i=O.getAll(t);let o;return o=e?n(D(e),(t=>e=>void 0!==t.id?e.filter(e=>e.identityOptions.id===t.id):e)(e))(i):i,o},z=t=>e=>e=>{const i=X(t,e),o=[];return i.forEach(t=>{t.timer&&t.timer.actions.abort(),o.push(t)}),e?o.forEach(e=>{v.remove(t,e.id)}):v.removeAll(t),Promise.resolve(o)},G=(t,e)=>({...t,dialogicOptions:{...t.dialogicOptions,...e}}),J=t=>e=>e=>{const i=e||{},o={id:i.id,spawn:i.spawn},n=X(t,o),s=n.filter(t=>!i.queued&&!t.dialogicOptions.queued),r=n.filter(t=>i.queued||t.dialogicOptions.queued),a=[];if(s.forEach(t=>a.push(W(G(t,i)))),r.length>0){const[e]=r;v.store(t,[e]),a.push(W(G(e,i)))}return Promise.all(a)},K=t=>e=>O.getCount(t,e),Q=(t,e)=>m(t.dialogicOptions,e),W=async function(t){t.transitionState=I,t.timer&&t.timer.actions.stop(),t.callbacks.willHide&&t.callbacks.willHide(t),await Q(t,a),t.callbacks.didHide&&t.callbacks.didHide(t);const e={...t};return v.remove(t.ns,t.id),Promise.resolve(e)},Y=({ns:t,queued:e,timeout:i})=>{const o="default_"+t,n="default_"+t,s={id:o,spawn:n,...e&&{queued:e},...void 0!==i&&{timeout:i}};return{ns:t,defaultId:o,defaultSpawn:n,defaultDialogicOptions:s,show:F(t)(s),hide:R(t)(s),hideAll:J(t)(s),resetAll:z(t)(s),pause:M(t)(s),resume:L(t)(s),exists:U(t)(s),getCount:K(t),isPaused:B(t)(s),getRemaining:$(t)(s)}},Z=Y({ns:"dialog"}),tt=Y({ns:"notification",queued:!0,timeout:3e3});t.actions=v,t.dialog=Z,t.dialogical=Y,t.exists=U,t.filterCandidates=(t,e,i)=>{const o=e[t]||[];return 0==o.length?[]:n(D(i),H)(o)},t.getCount=K,t.getRemaining=$,t.getTimerProperty=V,t.hide=R,t.hideAll=J,t.hideItem=W,t.isPaused=B,t.notification=tt,t.pause=M,t.remaining=t=>{let e,i=void 0,o=!1;const n={id:t.id,spawn:t.spawn},s=()=>{const r=t.instance.getRemaining(n);i!==r&&(i=void 0===r?r:t.roundToSeconds?Math.round(Math.max(r,0)/1e3):Math.max(r,0)),t.callback(i),t.instance.exists(n)?o||(e=window.requestAnimationFrame(s)):(window.cancelAnimationFrame(e),o=!0)};e=window.requestAnimationFrame(s)},t.resetAll=z,t.resume=L,t.selectors=O,t.setDomElement=(t,e)=>{e.dialogicOptions.domElement=t},t.show=F,t.showItem=async function(t){return t.callbacks.willShow&&t.callbacks.willShow(t),t.transitionState!==q&&(t.transitionState=q,await Q(t,r)),t.callbacks.didShow&&t.callbacks.didShow(t),t.dialogicOptions.timeout&&t.timer&&await async function(t,e,i){return e.actions.start(()=>W(t),i),V("getResultPromise",void 0)}(t,t.timer,t.dialogicOptions.timeout),Promise.resolve(t)},t.states=S,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=dialogic.js.map
